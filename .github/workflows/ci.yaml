name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    name: Preflight (select jobs)
    runs-on: ubuntu-latest
    outputs:
      run_build: ${{ steps.flags.outputs.run_build }}
      run_lint: ${{ steps.flags.outputs.run_lint }}
      run_format: ${{ steps.flags.outputs.run_format }}
      run_tests: ${{ steps.flags.outputs.run_tests }}
      run_e2e: ${{ steps.flags.outputs.run_e2e }}
    steps:
      - name: Checkout (for git log)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide which jobs to run
        id: flags
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          PUSH_MSG: ${{ github.event.head_commit.message }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          REF_NAME: ${{ github.ref_name }}
          PR_BRANCH: ${{ github.head_ref }}
        run: |
          set -euo pipefail

          if [[ "$EVENT_NAME" == "push" ]]; then
            MSG="$PUSH_MSG"
          else
            COMMIT_MSGS="$(git log -n 20 --pretty=%B | tr '\n' ' ')"
            MSG="$PR_TITLE $PR_BRANCH $COMMIT_MSGS"
          fi

          echo "Message used for CI selection: $MSG"

          # Defaults (baseline on PRs):
          RUN_BUILD=false
          RUN_LINT=true
          RUN_FORMAT=true
          RUN_TESTS=true
          RUN_E2E=false

          if [[ "$MSG" == *"[full]"* ]]; then
            RUN_BUILD=true
            RUN_E2E=true
          elif [[ "$MSG" == *"[lint]"* ]]; then
            RUN_TESTS=false
            RUN_E2E=false
          elif [[ "$MSG" == *"[test]"* ]]; then
            RUN_TESTS=true
            RUN_E2E=false
          fi

          # Policy: on main pushes always do everything
          if [[ "$EVENT_NAME" == "push" && "$REF_NAME" == "main" ]]; then
            RUN_BUILD=true
            RUN_E2E=true
          fi

          {
            echo "run_build=$RUN_BUILD"
            echo "run_lint=$RUN_LINT"
            echo "run_format=$RUN_FORMAT"
            echo "run_tests=$RUN_TESTS"
            echo "run_e2e=$RUN_E2E"
          } >> "$GITHUB_OUTPUT"

  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    needs: [preflight]
    if: needs.preflight.outputs.run_lint == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - run: ruff check .

  format:
    name: Format check (black)
    runs-on: ubuntu-latest
    needs: [preflight]
    if: needs.preflight.outputs.run_format == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - run: black --check .

  unit_tests:
    name: Unit tests (pytest, Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [preflight, lint, format]
    if: needs.preflight.outputs.run_tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - run: pytest -q

  build:
    name: Build (sdist + wheel)
    runs-on: ubuntu-latest
    needs: [preflight, lint, format]
    if: needs.preflight.outputs.run_build == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  e2e_smoke:
    name: E2E smoke (install + CLI + script)
    runs-on: ubuntu-latest
    needs: [preflight, unit_tests]
    if: needs.preflight.outputs.run_e2e == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - run: mc-pricer demo --cv --greeks --antithetic --n-paths 80000
      - run: python scripts/e2e_smoke.py
